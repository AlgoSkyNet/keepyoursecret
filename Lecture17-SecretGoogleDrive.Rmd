---
title: "Cryptorgraphy is more fun with R - Learn and use Public Key Cryptography with R Statistical Software"
output:
  html_document: default
  html_notebook: default
  word_document: default
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

https://www.udemy.com/keep-your-secrets-under-control

#### Disclamer

By joining this course or using material from the course you agree that all materials of the course are solely provided "as is" without any guarantee of functionality. All methods are provided for training purposes. Course developed by non security expert by explaining the practical use of **OpenSSL** software library in `R Statistical Software`. There is a risk that you can loose your information in case you are not properly follow the instructions or by loosing your private key or alike. Make sure you know what you do at any time when using the material of the course. Always test your knowledge on dummy data before applying it to real data... Memory areas for your private key, secrets, or passphrase are not securely cleaned after use. You are using the material of the course at your own risk!

#### Lecture 17 Keep Encrypted Data in cloud drive storage (Google/One Drive)

Hello and welcome back to the course. 

In the previous lectures you learnt:

* how to encrypt information in one click and keep in in the Computer File System. 
* how to keep and even share secrets in Public Version Control Repository..

In this lecture we will go further and see how to keep a backup copy of encrypted information in your personal **Google Drive** , **One Drive** or even **iDrive** cloud storage systems. We will review options of doing that including studying interactions of R with Google Drive cloud storage.

Let me immediately show you this slide. You see several components here. First is our computer with installed R software. You see also a USB key attached to it. It contains our private key. Next we see a folder named Desktip Client. In my case it's OneDrive because I am recording this session on my Windows machine. This can easily be iCloud or even Google Drive. What is important to notice is those yellow arrows indicating that whatever you put into these folders will be immediately syncronized to the cloud storage. Another thing we see here is our Google Drive storage. In fact blue lines are indicating that we can arrange these dataflows moving directly from R! Obviously last part of the story is our information. Yellow is our clear text information and red is our encrypted information.

Now let me immediately demonstrate how it works! In this case I am opening Folder containing my information I want to encrypt. Another folder contains One Drive folder the one is synchronized automatically. Finally you also see my web interface to my google drive account. Another element is my private key which I have on my USB stick named PRIVATE...

My file with data is just here and I am going to encrypt it. When I double click on the bat file encrypt.bat my file will dissapear and a moment later encrypted file will appear in those three places! Look at that! If I want to decrypt, I can launch decrypt.bat file and few moments later my files will be back to me! In this case I prefer to delete file which is in the google drive but to keep one on One Drive...

Let me now show you how it's all implemented: it is approximately 80 lines of code including spaces and comments. In my opinion it does not need much explanation because everything we see here was already covered in the preevious lectures. I just need to pay attention on new specific lines dedicated to google drive. 

First we obviously using library google drive. Second there is a line that copy file to OneDrive. Third there is a line responsible to upload file to Google Drive Storage.

Script responsible to decrypt is first attempt to decrypt using file stored in the folder. If it does not find it it will attempt to download this file from Google Drive. And finally once the decryption process is successful we can safely remove file from the Google Drive storage.

The only thing that require some explanation is how to establish and stop connection of R to Google Drive.

Let me start first how to stop the connection. Google creates special token file which you can see in our working directory. Let me now place this token to my R session.  
#### Stop the connection

Finally I will need to run command named drive_deauth() and this will stop authorisation.

```{r}
# stop the connection
# place .httr-oauth to R directory
drive_deauth()
```
#### Initialize connection to google

In order to re-establish the connection we need to launch command 

```{r}
# function to authorize google -> will redirect you to browser
drive_auth()
```

After allowing tidyverse api to connect the .httr-oauth token will be generated. What I do now is to manually take this file and place it to my folder where I have my files for encryption. This completes the steps we need...


#### conclusion

In this lecture we covered two possible ways of using Cloud drives to keep copy of encrypted information. One way is to simply place files to the folder that will be automatically synchronized with your computer and cloud drive. 

Another way that we just covered is slightly more complex but it allow us to directly send or retrieve files from Google Drive using R.

This is how we can keep our secrets more secured against loss of information! I hope you enjoyed this lecture. Thank you for keeping your interest to the course!



Credits: (http://googledrive.tidyverse.org)[http://googledrive.tidyverse.org]


### Additional Read

#### Keeping copy of files using Sync Folder

Let's start with keeping a copy of your files on the cloud drive systems. This does not require much explanation. We can simply write our files on iDrive One Drive folders on our computer. These files will be Synchronized with your cloud storage space automatically. All we need to do is to specify location of that folder 

#### Managing files directly from R (Google Drive)

What if I want to connect **R** to google drive directly? In order to demonstrate that I will run the core code from previous lectures to generate the secret in the encrypted form and store that to the file

... Make sure to revisit lecture explaining how to encrypt/decrypt information with one click...

```{r, message=FALSE, warning=FALSE}
# Used Libraries:
library(openssl)
library(tidyverse)

#### ENCRYPT ####
# pathPrvKeyUSB <- file.path("/Volumes/PRIVATE/private.key")
# pathPubKeyUSB <- file.path("/Volumes/PRIVATE/public.key")
# pathPasswFILE <- file.path("passwords.csv")
# pathEncryFILE <- file.path("password.Encrypted")
pathPrvKeyUSB <- file.path("F:/private.key")
pathPubKeyUSB <- file.path("F:/public.key")
pathPasswFILE <- file.path("C:/01_RSA", "passwords.csv")
pathEncryFILE <- file.path("C:/01_RSA", "password.Encrypted")

## Encrypting the secret and storing that to file "password.Encrypted"
if(identical(read_pubkey(pathPubKeyUSB)$fingerprint,
             read_key(pathPrvKeyUSB, password = "simple")$pubkey$fingerprint)) {
  read_csv(pathPasswFILE) %>% 
    # serialize the object
    serialize(connection = NULL) %>% 
    # encrypt the object
    encrypt_envelope(pathPubKeyUSB) %>% 
    # write encrypted data to File
    write_rds(pathEncryFILE) } else { print("You are attempting to encrypt without having proper copy of Private Key")}

## clean non encrypted file if encrypted file does exist and history...
if(file.exists(pathEncryFILE)) {file.remove(pathPasswFILE)}

## remove variables
remove(list = ls())

```

At this moment of time we have our file named `password.Encrypted` in the folder. Further on I will be using package *googledrive* to bring this file there (package website)[http://googledrive.tidyverse.org]. 

Let's load the package first

```{r, message=FALSE, warning=FALSE}
# installing and loading package
#install.packages("googledrive")
library(googledrive)
```

##### Assessing the package

When you run this package first time R will ask you to create a local file named ('.httr-oauth'), to cache OAuth access credentials. 

```{r}
drive_find(n_max = 10)
```

If we choose Yes R will redirect us to the browser where we will need to confirm which credentials we will use. Once we confirm all relevant authorisations we will see that local file oauth is generated. By default this file will not be checked in into git repository as it's already present in .gitignore file. In any case once we have this file we have our granted access to the google drive.

Finally let me demonstrate that I can upload my file with encrypted information by executing function drive upload.

```{r}
# uploads file to google drive

drive_upload(file.path("C:/01_RSA", "password.Encrypted"), verbose = FALSE)
```

That is it, file is in the Drive!!! Check it out!

##### check if the file is in the drive and delete local file [optional]

We can even check from R session that the file was recorded

```{r, message=FALSE, warning=FALSE}
# check that file is in the drive
isExist <- drive_find("password.Encrypted", verbose = FALSE)
View(isExist)
```

##### downloading the file from google drive

Let me now delete the file with encrypted information. As you see the file is not in the folder. In order to bring it back we can use function drive_download()

```{r}
# retrieve the encrypted file and placing that locally
drive_download(file = "password.Encrypted",
               path = file.path("C:/01_RSA", "password.Encrypted"), verbose = TRUE)
```

As you see now file was properly downloaded back.

##### Delete file from google drive

Let me also demonstrate how to delete this file with encrypted information from google drive folder. We will just use function `drive_rm()`: 

```{r}
# check if the file was downloaded
if(file.exists(file.path("C:/01_RSA", "password.Encrypted"))){
  # remove file from drive
  drive_rm("password.Encrypted")
}

```

Of course I will programmatically check presence of the file before doing so. As expected, the file was deleted!

##### Decrypting files

Let me now run the code to decrypt the file:

```{r}
# decrypting file and deleting it...

#### DECRYPT ####
# path to keys on USB Stick
# pathPrvKeyUSB <- file.path("/Volumes/PRIVATE/private.key")
# pathPubKeyUSB <- file.path("/Volumes/PRIVATE/public.key")
# pathPasswFILE <- file.path("passwords.csv")
# pathEncryFILE <- file.path("password.Encrypted")
pathPrvKeyUSB <- file.path("F:/private.key")
pathPubKeyUSB <- file.path("F:/public.key")
pathPasswFILE <- file.path("C:/01_RSA", "passwords.csv")
pathEncryFILE <- file.path("C:/01_RSA", "password.Encrypted")
# read file with Encrypted Information (from Computer File System to R Environment)
secret_encrypted <- read_rds(pathEncryFILE)

# decrypting the list from R Environment
decrypt_envelope(data = secret_encrypted$data,
                 iv = secret_encrypted$iv,
                 session = secret_encrypted$session,
                 key = pathPrvKeyUSB,
                 password = "simple") %>% 
  # getting back original object in a form of the data frame
  unserialize() %>% 
  # writing file back
  write_csv(pathPasswFILE)

# remove encrypted object
if(file.exists(pathPasswFILE)) {file.remove(pathEncryFILE)}

# remove secret_encrypted object
remove(list = ls())

```

#### Encrypt -> backup in Google Drive. With 1 Click!

Let me finally integrate google drive code to our original 1 click encryption script. Before I do this I will transfer my httr oath file to my script folder...

#### Encrypt

```{r}
# Used Libraries:
library(openssl)
library(tidyverse)
library(googledrive)

#### ENCRYPT ####
# You can encrypt both using private or public key
# NB: Make sure you have valid copy of Private Key matching your Public Key

pathPrvKeyUSB <- file.path("F:/private.key")
pathPubKeyUSB <- file.path("F:/public.key")
pathPasswFILE <- file.path("C:/01_RSA", "passwords.csv")
pathEncryFILE <- file.path("C:/01_RSA", "password.Encrypted")
pathhttrOAUTH <- file.path("C:/01_RSA", ".httr-oauth")

## Encrypting the secret and storing that to file "password.Encrypted"
if(identical(read_pubkey(pathPubKeyUSB)$fingerprint,
             read_key(pathPrvKeyUSB, password = "simple")$pubkey$fingerprint)) {
  read_csv(pathPasswFILE) %>% 
    # serialize the object
    serialize(connection = NULL) %>% 
    # encrypt the object
    encrypt_envelope(pathPubKeyUSB) %>% 
    # write encrypted data to File
    write_rds(pathEncryFILE) } else { print("You are attempting to encrypt without having proper copy of Private Key")}

## clean non encrypted file if encrypted file does exist and history...
if(file.exists(pathEncryFILE)) {
  # sending file to googledrive and removing local file
  drive_upload(pathEncryFILE, verbose = FALSE)
  file.remove(pathPasswFILE)}

## remove secret
remove(list = ls())
```

#### Decrypt

```{r}
# Used Libraries:
library(openssl)
library(tidyverse)
library(googledrive)

#### DECRYPT ####
# path to keys on USB Stick
pathPrvKeyUSB <- file.path("F:/private.key")
pathPubKeyUSB <- file.path("F:/public.key")
pathPasswFILE <- file.path("C:/01_RSA", "passwords.csv")
pathEncryFILE <- file.path("C:/01_RSA", "password.Encrypted")

# read file with Encrypted Information (from Computer File System to R Environment)
if(file.exists(pathEncryFILE)) {
	secret_encrypted <- read_rds(pathEncryFILE)
	} else {
	# attempt to download from googledrive
	drive_download(file = "password.Encrypted",
               path = pathEncryFILE, verbose = FALSE)
	secret_encrypted <- read_rds(pathEncryFILE)		   
	}

# decrypting the list from R Environment
decrypt_envelope(data = secret_encrypted$data,
                 iv = secret_encrypted$iv,
                 session = secret_encrypted$session,
                 key = pathPrvKeyUSB,
                 password = "simple") %>% 
  # getting back original object in a form of the data frame
  unserialize() %>% 
  # writing file back
  write_csv(pathPasswFILE)

# remove encrypted object
if(file.exists(pathPasswFILE)) {
	# remove file from googledrive
	drive_rm("password.Encrypted")
	file.remove(pathEncryFILE)}

# remove secret_encrypted object
rm(secret_encrypted)

```

Amazing!

























#### Stop the connection


```{r}
# stop the connection
# place .httr-oauth to R directory
drive_deauth()
```


#### Initialize connection to google

```{r}
# function to authorize google -> will redirect you to browser
drive_auth()
```














































