---
title: "Cryptorgraphy is more fun with R - Learn and use Public Key Cryptography with R Statistical Software"
output:
  html_document: default
  html_notebook: default
  word_document: default
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

https://www.udemy.com/keep-your-secrets-under-control

#### Disclamer

By joining this course or using material from the course you agree that all materials of the course are solely provided "as is" without any guarantee of functionality. All methods are provided for training purposes. Course developed by non security expert by explaining the practical use of **OpenSSL** software library in `R Statistical Software`. There is a risk that you can loose your information in case you are not properly follow the instructions or by loosing your private key or alike. Make sure you know what you do at any time when using the material of the course. Always test your knowledge on dummy data before applying it to real data... Memory areas for your private key, secrets, or passphrase are not securely cleaned after use. You are using the material of the course at your own risk!

#### Lecture 17 Keep Encrypted Data in cloud drive storage (Google/One Drive)

Hello and welcome back to the course. 

In the previous lectures you learnt:

* how to encrypt information in one click and keep in in the Computer File System. 
* how to keep and even share secrets in Public Version Control Repository..

In this lecture we will go further and see how to keep a copy of encrypted information in **Google Drive** or **One Drive** cloud storage. This is very useful or probably a must as you may want to make sure you don't loose your information in case, for example, you loose access to your hardware

We will cover few simple options starting from:

* simple idea of keeping copy on One Drive, Google Drive or even iDrive desktop folder if you are Mac user
* and even slightly advanced automating process when we send data to Google Drive directly from R

Last point related to interaction of R with your Private Cloud Storage is very interesting not only for cryptography but for simple automation of your files

By the end of this lecture you will be able to recreate process described on this slide.

#### Keeping copy of files using Sync Folder

This does not require much explanation. Simply put your files on iDrive One Drive folders. These files will be Synchronized with your cloud storage space automatically.

#### Managing files directly from R (Google Drive)

What if I want to connect **R** to google drive directly? In order to demonstrate that I will run the core code from previous lectures to generate the secret in the encrypted form and store that to the file

... Make sure to revisit lecture explaining how to encrypt/decrypt information with one click...

```{r, message=FALSE, warning=FALSE}
# Used Libraries:
library(openssl)
library(tidyverse)

#### ENCRYPT ####
# pathPrvKeyUSB <- file.path("/Volumes/PRIVATE/private.key")
# pathPubKeyUSB <- file.path("/Volumes/PRIVATE/public.key")
# pathPasswFILE <- file.path("passwords.csv")
# pathEncryFILE <- file.path("password.Encrypted")
pathPrvKeyUSB <- file.path("F:/private.key")
pathPubKeyUSB <- file.path("F:/public.key")
pathPasswFILE <- file.path("C:/01_RSA", "passwords.csv")
pathEncryFILE <- file.path("C:/01_RSA", "password.Encrypted")

## Encrypting the secret and storing that to file "password.Encrypted"
if(identical(read_pubkey(pathPubKeyUSB)$fingerprint,
             read_key(pathPrvKeyUSB, password = "simple")$pubkey$fingerprint)) {
  read_csv(pathPasswFILE) %>% 
    # serialize the object
    serialize(connection = NULL) %>% 
    # encrypt the object
    encrypt_envelope(pathPubKeyUSB) %>% 
    # write encrypted data to File
    write_rds(pathEncryFILE) } else { print("You are attempting to encrypt without having proper copy of Private Key")}

## clean non encrypted file if encrypted file does exist and history...
if(file.exists(pathEncryFILE)) {file.remove(pathPasswFILE)}

## remove variables
remove(list = ls())

```

At this moment of time we have our file named `password.Encrypted` in the folder. Further on I will be using package *googledrive* to bring this file there (package website)[http://googledrive.tidyverse.org]. 

Let's load the package first

```{r, message=FALSE, warning=FALSE}
# installing and loading package
#install.packages("googledrive")
library(googledrive)
```

##### Assessing the package

When you run this package first time R will ask you to create a local file named ('.httr-oauth'), to cache OAuth access credentials. 

```{r}
drive_find(n_max = 10)
```

If we choose Yes R will redirect us to the browser where we will need to confirm which credentials we will use. Once we confirm all relevant authorisations we will see that local file oauth is generated. By default this file will not be checked in into git repository as it's already present in .gitignore file. In any case once we have this file we have our granted access to the google drive.

Finally let me demonstrate that I can upload my file with encrypted information by executing function drive upload.

```{r}
# uploads file to google drive

drive_upload(file.path("C:/01_RSA", "password.Encrypted"), verbose = FALSE)
```

That is it, file is in the Drive!!! Check it out!

##### check if the file is in the drive and delete local file [optional]

We can even check from R session that the file was recorded

```{r, message=FALSE, warning=FALSE}
# check that file is in the drive
isExist <- drive_find("password.Encrypted", verbose = FALSE)
View(isExist)
```

##### downloading the file from google drive

Let me now delete the file with encrypted information. As you see the file is not in the folder. In order to bring it back we can use function drive_download()

```{r}
# retrieve the encrypted file and placing that locally
drive_download(file = "password.Encrypted",
               path = file.path("C:/01_RSA", "password.Encrypted"), verbose = TRUE)
```

As you see now file was properly downloaded back.

##### Delete file from google drive

Let me also demonstrate how to delete this file with encrypted information from google drive folder. We will just use function `drive_rm()`: 

```{r}
# check if the file was downloaded
if(file.exists(file.path("C:/01_RSA", "password.Encrypted"))){
  # remove file from drive
  drive_rm("password.Encrypted")
}

```

Of course I will programmatically check presence of the file before doing so. As expected, the file was deleted!

##### Decrypting files

Let me now run the code to decrypt the file:

```{r}
# decrypting file and deleting it...

#### DECRYPT ####
# path to keys on USB Stick
# pathPrvKeyUSB <- file.path("/Volumes/PRIVATE/private.key")
# pathPubKeyUSB <- file.path("/Volumes/PRIVATE/public.key")
# pathPasswFILE <- file.path("passwords.csv")
# pathEncryFILE <- file.path("password.Encrypted")
pathPrvKeyUSB <- file.path("F:/private.key")
pathPubKeyUSB <- file.path("F:/public.key")
pathPasswFILE <- file.path("C:/01_RSA", "passwords.csv")
pathEncryFILE <- file.path("C:/01_RSA", "password.Encrypted")
# read file with Encrypted Information (from Computer File System to R Environment)
secret_encrypted <- read_rds(pathEncryFILE)

# decrypting the list from R Environment
decrypt_envelope(data = secret_encrypted$data,
                 iv = secret_encrypted$iv,
                 session = secret_encrypted$session,
                 key = pathPrvKeyUSB,
                 password = "simple") %>% 
  # getting back original object in a form of the data frame
  unserialize() %>% 
  # writing file back
  write_csv(pathPasswFILE)

# remove encrypted object
if(file.exists(pathPasswFILE)) {file.remove(pathEncryFILE)}

# remove secret_encrypted object
remove(list = ls())

```

#### Encrypt -> backup in Google Drive. With 1 Click!

Let me finally integrate google drive code to our original 1 click encryption script. Before I do this I will transfer my httr oath file to my script folder...

#### Encrypt

```{r}
# Used Libraries:
library(openssl)
library(tidyverse)
library(googledrive)

#### ENCRYPT ####
# You can encrypt both using private or public key
# NB: Make sure you have valid copy of Private Key matching your Public Key

pathPrvKeyUSB <- file.path("F:/private.key")
pathPubKeyUSB <- file.path("F:/public.key")
pathPasswFILE <- file.path("C:/01_RSA", "passwords.csv")
pathEncryFILE <- file.path("C:/01_RSA", "password.Encrypted")
pathhttrOAUTH <- file.path("C:/01_RSA", ".httr-oauth")

## Encrypting the secret and storing that to file "password.Encrypted"
if(identical(read_pubkey(pathPubKeyUSB)$fingerprint,
             read_key(pathPrvKeyUSB, password = "simple")$pubkey$fingerprint)) {
  read_csv(pathPasswFILE) %>% 
    # serialize the object
    serialize(connection = NULL) %>% 
    # encrypt the object
    encrypt_envelope(pathPubKeyUSB) %>% 
    # write encrypted data to File
    write_rds(pathEncryFILE) } else { print("You are attempting to encrypt without having proper copy of Private Key")}

## clean non encrypted file if encrypted file does exist and history...
if(file.exists(pathEncryFILE)) {
  # sending file to googledrive and removing local file
  drive_upload(pathEncryFILE, verbose = FALSE)
  file.remove(pathPasswFILE)}

## remove secret
remove(list = ls())
```

#### Decrypt

```{r}
# Used Libraries:
library(openssl)
library(tidyverse)
library(googledrive)

#### DECRYPT ####
# path to keys on USB Stick
pathPrvKeyUSB <- file.path("F:/private.key")
pathPubKeyUSB <- file.path("F:/public.key")
pathPasswFILE <- file.path("C:/01_RSA", "passwords.csv")
pathEncryFILE <- file.path("C:/01_RSA", "password.Encrypted")

# read file with Encrypted Information (from Computer File System to R Environment)
if(file.exists(pathEncryFILE)) {
	secret_encrypted <- read_rds(pathEncryFILE)
	} else {
	# attempt to download from googledrive
	drive_download(file = "password.Encrypted",
               path = pathEncryFILE, verbose = FALSE)
	secret_encrypted <- read_rds(pathEncryFILE)		   
	}

# decrypting the list from R Environment
decrypt_envelope(data = secret_encrypted$data,
                 iv = secret_encrypted$iv,
                 session = secret_encrypted$session,
                 key = pathPrvKeyUSB,
                 password = "simple") %>% 
  # getting back original object in a form of the data frame
  unserialize() %>% 
  # writing file back
  write_csv(pathPasswFILE)

# remove encrypted object
if(file.exists(pathPasswFILE)) {
	# remove file from googledrive
	drive_rm("password.Encrypted")
	file.remove(pathEncryFILE)}

# remove secret_encrypted object
rm(secret_encrypted)

```

Amazing!


#### conclusion

In this lecture we covered two possible ways of using Cloud drives to keep copy of encrypted information. One way is to simply place files to the folder that will be automatically synched with your computer. And another way is slightly more complex is to directly send or retrieve files from R.

This is how we can keep our secrets more secured against loss of information! I hope you enjoyed this lecture, Thank you for keeping your interest to the course!



Credits: (http://googledrive.tidyverse.org)[http://googledrive.tidyverse.org]