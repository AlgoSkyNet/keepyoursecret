---
title: "Cryptorgraphy is more fun with R - Learn and use Public Key Cryptography with R Statistical Software"
output:
  html_document: default
  html_notebook: default
  word_document: default
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

https://www.udemy.com/keep-your-secrets-under-control

#### Disclamer

By joining this course or using material from the course you agree that all materials of the course are solely provided "as is" without any guarantee of functionality. All methods are provided for training purposes. Course developed by non security expert by explaining the practical use of **OpenSSL** software library in `R Statistical Software`. There is a risk that you can loose your information in case you are not properly follow the instructions or by loosing your private key or alike. Make sure you know what you do at any time when using the material of the course. Always test your knowledge on dummy data before applying it to real data... Memory areas for your private key, secrets, or passphrase are not securely cleaned after use. You are using the material of the course at your own risk!

#### Lecture 17 Keep Encrypted Data in cloud drive storage (Google/One Drive)

Hello and welcome back to the course. 

In the previous lectures you learnt:

* how to encrypt information in one click and keep in in the Computer File System. 
* how to keep and even share secrets in Public Version Control Repository..

In this lecture we will go further and see how to keep a backup copy of encrypted information in your personal **Google Drive** , **One Drive** or even **iDrive** cloud storage systems. 


#### Keeping copy of files using Sync Folder

Let's start with keeping a copy of your files on the cloud drive systems. This does not require much explanation. We can simply write our files on iDrive One Drive folders on our computer. These files will be Synchronized with your cloud storage space automatically. All we need to do is to specify location of that folder 

Just use functions like: `file.copy(from, to)`

### Managing files directly from R (Google Drive)

#### Initialize connection to google

In order to re-establish the connection we need to launch command 

```{r, eval=FALSE, include=TRUE}
# function to authorize google -> will redirect you to browser
drive_auth()
```

After allowing tidyverse api to connect the .httr-oauth token will be generated. What I do now is to manually take this file and place it to my folder where I have my files for encryption. This completes the steps we need...


#### Stop the connection

Nun command named `drive_deauth()` and this will stop authorisation.

```{r, eval=FALSE, include=TRUE}
# stop the connection
# place .httr-oauth to R directory
drive_deauth()
```

#### other way to start connection or retreive info about files stored:

This function `drive_find()` will return info about files stored by google drive

```{r, eval=FALSE, include=TRUE}
drive_find(n_max = 10)
```

#### upload files

```{r, eval=FALSE, include=TRUE}
# uploads file to google drive

drive_upload(file.path("C:/01_RSA", "password.Encrypted"), verbose = FALSE)
```

That is it, file is in the Drive!!! Check it out!

#### check if the file is in the drive and delete local file [optional]

We can even check from R session that the file was recorded

```{r, eval=FALSE, include=TRUE}
# check that file is in the drive
isExist <- drive_find("password.Encrypted", verbose = FALSE)
View(isExist)
```

##### downloading the file from google drive

Let me now delete the file with encrypted information. As you see the file is not in the folder. In order to bring it back we can use function drive_download()

```{r, eval=FALSE, include=TRUE}
# retrieve the encrypted file and placing that locally
drive_download(file = "password.Encrypted",
               path = file.path("C:/01_RSA", "password.Encrypted"), verbose = TRUE)
```

As you see now file was properly downloaded back.

##### Delete file from google drive

Let me also demonstrate how to delete this file with encrypted information from google drive folder. We will just use function `drive_rm()`: 

```{r, eval=FALSE, include=TRUE}
# check if the file was downloaded
if(file.exists(file.path("C:/01_RSA", "password.Encrypted"))){
  # remove file from drive
  drive_rm("password.Encrypted")
}

```

Of course I will programmatically check presence of the file before doing so. As expected, the file was deleted!

##### Decrypting files

Let me now run the code to decrypt the file:

```{r, eval=FALSE, include=TRUE}
# decrypting file and deleting it...

#### DECRYPT ####
# path to keys on USB Stick
# pathPrvKeyUSB <- file.path("/Volumes/PRIVATE/private.key")
# pathPubKeyUSB <- file.path("/Volumes/PRIVATE/public.key")
# pathPasswFILE <- file.path("passwords.csv")
# pathEncryFILE <- file.path("password.Encrypted")
pathPrvKeyUSB <- file.path("F:/private.key")
pathPubKeyUSB <- file.path("F:/public.key")
pathPasswFILE <- file.path("C:/01_RSA", "passwords.csv")
pathEncryFILE <- file.path("C:/01_RSA", "password.Encrypted")
# read file with Encrypted Information (from Computer File System to R Environment)
secret_encrypted <- read_rds(pathEncryFILE)

# decrypting the list from R Environment
decrypt_envelope(data = secret_encrypted$data,
                 iv = secret_encrypted$iv,
                 session = secret_encrypted$session,
                 key = pathPrvKeyUSB,
                 password = "simple") %>% 
  # getting back original object in a form of the data frame
  unserialize() %>% 
  # writing file back
  write_csv(pathPasswFILE)

# remove encrypted object
if(file.exists(pathPasswFILE)) {file.remove(pathEncryFILE)}

# remove secret_encrypted object
remove(list = ls())

```

#### Encrypt -> backup in Google Drive. With 1 Click!

Let me finally integrate google drive code to our original 1 click encryption script. Before I do this I will transfer my httr oath file to my script folder...

#### Encrypt

```{r, eval=FALSE, include=TRUE}
# Used Libraries:
library(openssl)
library(tidyverse)
library(googledrive)

#### ENCRYPT ####
# You can encrypt both using private or public key
# NB: Make sure you have valid copy of Private Key matching your Public Key

pathPrvKeyUSB <- file.path("F:/private.key")
pathPubKeyUSB <- file.path("F:/public.key")
pathPasswFILE <- file.path("C:/01_RSA", "passwords.csv")
pathEncryFILE <- file.path("C:/01_RSA", "password.Encrypted")
pathhttrOAUTH <- file.path("C:/01_RSA", ".httr-oauth")

## Encrypting the secret and storing that to file "password.Encrypted"
if(identical(read_pubkey(pathPubKeyUSB)$fingerprint,
             read_key(pathPrvKeyUSB, password = "simple")$pubkey$fingerprint)) {
  read_csv(pathPasswFILE) %>% 
    # serialize the object
    serialize(connection = NULL) %>% 
    # encrypt the object
    encrypt_envelope(pathPubKeyUSB) %>% 
    # write encrypted data to File
    write_rds(pathEncryFILE) } else { print("You are attempting to encrypt without having proper copy of Private Key")}

## clean non encrypted file if encrypted file does exist and history...
if(file.exists(pathEncryFILE)) {
  # sending file to googledrive and removing local file
  drive_upload(pathEncryFILE, verbose = FALSE)
  file.remove(pathPasswFILE)}

## remove secret
remove(list = ls())
```

#### Decrypt

```{r, eval=FALSE, include=TRUE}
# Used Libraries:
library(openssl)
library(tidyverse)
library(googledrive)

#### DECRYPT ####
# path to keys on USB Stick
pathPrvKeyUSB <- file.path("F:/private.key")
pathPubKeyUSB <- file.path("F:/public.key")
pathPasswFILE <- file.path("C:/01_RSA", "passwords.csv")
pathEncryFILE <- file.path("C:/01_RSA", "password.Encrypted")

# read file with Encrypted Information (from Computer File System to R Environment)
if(file.exists(pathEncryFILE)) {
	secret_encrypted <- read_rds(pathEncryFILE)
	} else {
	# attempt to download from googledrive
	drive_download(file = "password.Encrypted",
               path = pathEncryFILE, verbose = FALSE)
	secret_encrypted <- read_rds(pathEncryFILE)		   
	}

# decrypting the list from R Environment
decrypt_envelope(data = secret_encrypted$data,
                 iv = secret_encrypted$iv,
                 session = secret_encrypted$session,
                 key = pathPrvKeyUSB,
                 password = "simple") %>% 
  # getting back original object in a form of the data frame
  unserialize() %>% 
  # writing file back
  write_csv(pathPasswFILE)

# remove encrypted object
if(file.exists(pathPasswFILE)) {
	# remove file from googledrive
	drive_rm("password.Encrypted")
	file.remove(pathEncryFILE)}

# remove secret_encrypted object
rm(secret_encrypted)

```



Credits: (http://googledrive.tidyverse.org)[http://googledrive.tidyverse.org]

