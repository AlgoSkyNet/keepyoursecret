---
title: "Keep your secrets under control - Cryptography for All"
output:
  html_document: default
  html_notebook: default
  word_document: default
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

https://www.udemy.com/keep-your-secrets-under-control

#### Disclamer

By joining this course or using material from the course you agree that all materials of the course are solely provided "as is" without any guarantee of functionality. All methods are provided for training purposes. Course developed by non security expert by explaining the practical use of **OpenSSL** software library in `R Statistical Software`. There is a risk that you can loose your information in case you are not properly follow the instructions or by loosing your private key or alike. Make sure you know what you do at any time when using the material of the course. Always test your knowledge on dummy data before applying it to real data... Memory areas for your private key, secrets, or passphrase are not securely cleaned after use. You are using the material of the course at your own risk!

#### Lecture 16 Keep Common Secret in Public Version Control

Hello and welcome back to the course Keep Your secret under your control. In this lecture we will cover simple idea of keeping encrypted information in the Public Git Hub Repository. Even further you will see how easy it is to keep common secret (user credentials) easily available for you and your collaborators

Our goal will be to see how to use package 'secret' in R to keep part of R project encrypted:

* Creating vault and managing your own secrets in R in Version Control
* Adding collaborators
* Short assignment for you

##### Learn 'secret' package for your own secrets in Version Control

We will start by loading package secret

```{r}
# if necessary install.packages("secret")
library(secret)
```

// Authors: "Gábor Csárdi and Andrie de Vries".

This package uses openssl library and it's very useful to collaborate and keep common secrets in Public Repositories directly via Version Control

Our scenario for this lecture will be to:

* create vault
* add users to the vault
* add secret to the vault
* get the secret from the vault
* updating the secret in the vault
* adding users to access the secret...
* deleting the secrets...

##### vault

A vault is a folder that will contain public keys of the users... you can easily create that in your R project file by executing command

```{r}
# create vault
if(!dir.exists("COMMON_SECRETS")){
create_vault("COMMON_SECRETS")}
```

Feel free to open folder... as you will notice package will automatically add sub-folders

##### add users

Now we will add users to the vault. At first I will be using my public key stored in my USB key

```{r}
# adding user to the vault
add_user(email = "vz",
         public_key = file.path("/Volumes/PRIVATE/public.key"),
         vault = "COMMON_SECRETS")
```

What is happenning now is that function is now adding 'public' key to the folder users

##### add secrets

The next step for me will be to add a secret to our vault. In this case I will use my csv file 'passwords.csv'. 

```{r}
# adding a secret
secret <- read_csv("passwords.csv")

add_secret(name = "secret", 
           value = secret,
           users = "vz",
           vault = "COMMON_SECRETS")

# remove secret from the R Environment
rm(secret)
```

Right now we can check that secret with the name 'secret' is already in the Vault. You can even find dedicated folder there. This vault can be obviously be 'commit' ted to the Public Repository...

##### get secrets

Next I will demonstrate the ability to decrypt secret of the user 'vz' having the private key... 

```{r}
# decrypting secret from Vault (password from private key is asked in interactive mode)
get_secret("secret",
            key = file.path("/Volumes/PRIVATE/private.key"),
            vault = "COMMON_SECRETS")
```



Objective of the lecture was to share secret. For that I will now add another user. This user named 'sam' has provided his public key...

```{r}
# sam.public.key is stored in the R Project file
add_user("sam", public_key = "sam.public.key",
         vault = "COMMON_SECRETS")
```

If I now check my vault I will see there file 'sam.pem'.

It is possible to list users that are in the vault:

```{r}
list_users(vault = "COMMON_SECRETS")
```

and the secrets that are in the vault:
```{r}
list_secrets(vault = "COMMON_SECRETS")
```

at this moment sam can't access secret:

```{r}
secretbob <- get_secret("secret",
                     key = "sam.private.key",
                     vault = "COMMON_SECRETS")
```

I is necessary to delet and then share the secrets again:

```{r}
# delete secret
delete_secret("secret", vault = "COMMON_SECRETS")
# adding secret for both sam and vz
add_secret(name = "secret", 
           value = secret,
           users = c("vz","sam"),
           vault = "COMMON_SECRETS")
```

Now 'sam' can det the secret:

```{r}
# secret read by bob
secretBob <- get_secret("secret",
                        key = "sam.private.key",
                        vault = "COMMON_SECRETS")
```

Now let's assume that I have a Database API key that I want to encrypt!

```{r}
# adding api keys as a secret
add_secret(name = "api_key1",
           value = "q342sde099sdsdflfnaks972k2l",
           users = c("vz", "sam"),
           vault = "COMMON_SECRETS")
```

Once the changes are committed to the github repository it will become possible for both users to access this api key!!!

Package secret also allowing to stop access to the vault with specific secret

```{r}
# unshare secret to bob
unshare_secret("api_key1", users = "sam", vault = "COMMON_SECRETS")
```

Sam will not be able to read this secret anylonger

```{r}
# trying to read secret with sam's private key
get_secret("api_key1", key = "sam.private.key", vault = "COMMON_SECRETS")
```

At this point we have covered the scenario of keeping shared information in the public repository. This is now possible to keep encrypted information in the vault, manage access to this informtion to several users who provided us their public keys...

I have provided an assignment for you to be able to go and practice using package secret.

I will be waiting you in the next lecture where we will talk about how to keep your encrypted secrets in your google drive folder!!!

Exercises:
1. Create a vault and name it "S.VAULT"
2. Generate Private keys for the 1 generic user 'user1' and use your own public key. You will be 'user0'
3. Add users to the vault
4. Add secret 'mtcars', encrypt entire dataset mtcars for that, make it available for both 'user0' and 'user1' users
5. Check that 'user1' can decrypt the secret 'mtcars'
6. Delete user 'user1' 
7. Try to decrypt 'mtcars' with private key from 'user1
8. Delete secret 'mtcars'