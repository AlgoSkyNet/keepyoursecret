---
title: "Cryptorgraphy is more fun with R - Learn and use Public Key Cryptography with R Statistical Software"
output:
  html_document: default
  html_notebook: default
  word_document: default
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

https://www.udemy.com/keep-your-secrets-under-control

#### Disclamer

By joining this course or using material from the course you agree that all materials of the course are solely provided "as is" without any guarantee of functionality. All methods are provided for training purposes. Course developed by non security expert by explaining the practical use of **OpenSSL** software library in `R Statistical Software`. There is a risk that you can loose your information in case you are not properly follow the instructions or by loosing your private key or alike. Make sure you know what you do at any time when using the material of the course. Always test your knowledge on dummy data before applying it to real data... Memory areas for your private key, secrets, or passphrase are not securely cleaned after use. You are using the material of the course at your own risk!

#### Lecture 18 Stop exposing your passwords in clear text!

Hello and welcome back to the course. 

This lecture will be dedicated to achieve one simple goal: "How to avoid keeping password in clear text in our scripts we checking in to the Version Control Repositories". This lecture also compliment previously covered topic about using Public Version control repository. In fact if you use package `secret` then you should be already fine. This lecture is only useful if you don't plan to collaborate and just want to avoid exposing password in your code directly using `openssl`. It is slightly simple and without creating a vault, users and registering public keys

#### Scenario

Usually in your R script or shiny Apps you may have a function that contact SQL server to grab a data. This function may need user credentials such as *User Name* and *Passwords*. 

Let's expose original code containing password in clear text:

```{r, eval=FALSE, include=TRUE}
# in this example we use function from RODBC library
library(RODBC) 

# function that connects to SQL and return DF object
getDataFromSQL <- function(wrkTableName = "WRK_TABLE_NAME",
                           connection = "SQL_SERVER_NAME",
                           userID = "SQL_USER_ID",
                           passID = "Your_Exposed_Password:*("){
  
  ch2<-odbcConnect(connection,uid = userID,pwd=passID)
  if(ch2 == -1){
    print("Error: connection was not established")
    
    }else{
      # Contruct SQL request
      sql.request2 <- paste("SELECT * FROM", wrkTableName)
      # Contruct SQL request and get data
      res2 <- as.data.frame(sqlQuery(ch2, sql.request2))
      odbcClose(ch2)
      return(res2)
      
  }
}

# usage of this function
Data <- getDataFromSQL("DB_NAME.dbo.WRK_TABLENAME")

```

You don't want to keep this code in your Version Control Repository or even in your Documentation because it is containing password in clear text!!!

#### Solution

In this lecture we will expose one way avoiding this by encrypting your password in your project and keeping your private key inside of your Virutal Private Server File System. The main idea is graphically represented in this slide.

##### Preparation - place our Private Key to the dedicated folder

In order to make everything happen you should generate your private key and place it to the specific folder typically accessible to all your applications. 
For example, I will create a folder named `"~/ShinyApps/.rsa/"` and will place there my private key `"key.pem"`. Working application or script can get access to this folder using the following path: `"~/ShinyApps/.rsa/key.pem"`

Notice that by using `'.'` before the folder name will make this folder hidden. You may potentially not seeing it... This is small additional protection for your key...

##### Encrypt you password - do this once!

Next thing we need to proceed is to encrypt our password. We know how to do this already:

```{r}
## Encrypt with PRIVATE key (e.g. use this code yourself)
"YourNotExposedPassword" %>% 
  # serialize the object
  serialize(connection = NULL) %>% 
  # encrypt the object
  encrypt_envelope("~/ShinyApps/.rsa/key.me") %>% 
  # write encrypted data to File
  write_rds("Public.rds")
```

`remember to erase the string and clear the history!`

When you run this code file 'Public.rds' will be generated. It will contain our password. You can decide if you want to check it it to version control or not. This object must be available for your Script or ShinyApp and it contains our encrypted password

##### Adapting function

We rewrite this function and simply remove the password

```{r}
# function that connects to SQL and return DF object, there is no password in clear text...!!!
getDataFromSQL <- function(wrkTableName = "WRK_TABLE_NAME",
                           connection = "SQL_SERVER_NAME",
                           userID = "SQL_USER_ID",
                           passID){
  
  ch2<-odbcConnect(connection,uid = userID,pwd = passID)
  if(ch2 == -1){
    print("Error: connection was not established")
    
  }else{
    # Contruct SQL request
    sql.request2 <- paste("SELECT * FROM", wrkTableName)
    # Contruct SQL request and get data
    res2 <- as.data.frame(sqlQuery(ch2, sql.request2))
    odbcClose(ch2)
    return(res2)
  }
}
```


##### Retrieve the password

Finally when we run our application or shiny app we can retrieve our key

```{r}
# retrieve password
out <- readRDS("Public.rds")

# decrypting the password using public data list and private key
pass <- decrypt_envelope(out$data, out$iv, out$session, "~/ShinyApps/.rsa/key.pem", password = "") %>% 
  unserialize()

```

And finally we can use our code to get the data

```{r}
# data frame containing flow information
DF_Data <- getDataFromSQL("DB_NAME.dbo.WRK_TABLENAME", passID = pass)

```

##### Clear password

The last thing we must do is to remove passwords from the memory

```{r}
# remove password object
rm(pass, out)
```


#### Conclusion

We can 

