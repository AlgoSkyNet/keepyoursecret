---
title: "Keep your secrets under control - Cryptography for All"
output:
  html_document: default
  html_notebook: default
  word_document: default
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

#### Disclamer

By joining this course or using material from the course you agree that all materials of the course are solely provided "as is" without any guarantee of functionality. All methods are provided for training purposes. Course developed by non security expert by explaining the practical use of **OpenSSL** software library in `R Statistical Software`. There is a risk that you can loose your information in case you are not properly follow the instructions or by loosing your private key or alike. Make sure you know what you do at any time when using the material of the course. Always test your knowledge on dummy data before applying it to real data... Memory areas for your private key, secrets, or passphrase are not securely cleaned after use. You are using the material of the course at your own risk!

#### Lecture 10 Simulating Disaster (Understanding Risks of loosing information)

Hello and welcome back to the course Keep Your Secret under Your Control. As you probably already captured in a previous lectures Encrypting and Decrypting process takes seconds. However what if due to several reasons something goes wrong? Realise that later may be painful. This is why I thought it will be better to simulate such situations. Let's call them 'disasters'. Let's re-create them before they happens and prevent them accordinly...

We will review following situations that can lead to disaster and think about possible strategies on how to prevent the disasters... additionally I will welcome you to visit the assignment part of the lecture. There you will have these "cheat-sheets" available to you as a pdf file. Try to reflect on those and critically think what can go wrong...

From my personal point of view these disasters may fall into 2 categories: 

##### Not possible to De-Crypt Information

* Encrypting with Public Key, deleting Information, not having corresponding Private Key...
* Loosing encrypted information or Private Key (e.g. overwriting them)
* Forgetting passphrase to your Private Key file
* Forgetting a method of Decryption

##### Keys becoming public...

* Submitting your private key or passphrases to public repository
* Loosing control on USB keys or computers with Private Key
* In general wrong management of Public and Private keys

Please pause the video and read those situations very, very attentively. This lecture is just about that to let you think on the consequences of loosing information or leaking sensitive information. 

Let's start with situations when we can encrypt but could not decrypt it anymore ...

This is an example how can it happen that we can generate new private key and accidentally remove already existing one. Think if you have already have encrypted information that you can't decrypt anymore!!!:

```{r}
library(openssl)
library(tidyverse)

# 1. I have my public key in the R Project Folder
file.exists("public.key")

# 2. I would encrypt my text using that public key
mySECRET <- "my specially important text string"
mySECRET %>% 
  # serialize the object
  serialize(connection = NULL) %>% 
  # encrypt the object
  encrypt_envelope("public.key") %>% 
  # write encrypted data to File
  write_rds("myString.Encrypted")

# 3. Delete information...
rm(mySECRET)

# 3. This time I would SIMULATE disaster... I am creating new pairs of keys...
# generating and writing new private key
rsa_keygen(bits = 2099) %>% 
  write_pem(path = "private.key", password = "udemy")

# 4. Now I will attempt to decrypt my encrypted information...
secret_encrypted <- read_rds("myString.Encrypted")

# decrypting the list from R Environment
decrypt_envelope(data = secret_encrypted$data,
                 iv = secret_encrypted$iv,
                 session = secret_encrypted$session,
                 key = "private.key",
                 password = "udemy") %>% 
  # getting back original object in a form of the data frame
  unserialize() 
```

oops there is an error...

Let's think how to prevent that?

* One strategy if you are the owner of the information and at the same time you are encrypting this information for yourself. Simply always using Private Key! Or generate Public Key everytime you need to Encrypt
* Use 'hash' md5 fingerprint is corresponding to the one from Private Key
* One option will be to name the Private Key file in a way that the name is always unique. For example perhaps we can name the private key file using md5 sum or fingerprint hash...
* Another interesting option is to try decrypting information before you delete original data...
* You can perhaps name more? Add your ideas to discussion board of the course!!!

Probably among different strategies the best one is the one that allows automation...

```{r}
# 1. I have my public key in the R Project Folder
file.exists("public.key")

# 2. I would encrypt my text using that public key, but now I will check if I have corresponding Private Key!!!
if(identical(read_pubkey("public.key")$fingerprint,
             read_key("private.key", password = "udemy")$pubkey$fingerprint)) {
"my specially important text string" %>% 
  # serialize the object
  serialize(connection = NULL) %>% 
  # encrypt the object
  encrypt_envelope("public.key") %>% 
  # write encrypted data to File
  write_rds("myString.Encrypted") } else { print("You are attempting to encrypt without having proper copy of Private Key")}

```

* Loosing encrypted information or Private Key

You can simply delete your encrypted information or overwrite them!

```{r}
# encrypt mtcars dataset and delete Private Key...
# 2.1. If I will use the same construct but with backup_private.key ...
if(identical(read_pubkey("public.key")$fingerprint,
             read_key("private.key", password = "udemy")$pubkey$fingerprint)) {
mtcars %>% 
  # serialize the object
  serialize(connection = NULL) %>% 
  # encrypt the object
  encrypt_envelope("public.key") %>% 
  # write encrypted data to File
  write_rds("mtcars.Encrypted") } else { print("You are attempting to encrypt without having proper copy of Private Key")}

# # deleting encrypted object (NB: !!!simulating disaster!!!)
# file.remove("mtcars.Encrypted")
# 
# # deleting Private Key
# file.remove("private.key")
```


Probably the best strategy to avoid loosing information that is encrypted is to have a solid method of storing this information. Things to consider:

* keeping backup oe encrypted information copy in the folder 'One Drive' synchronized to the server
* keeping a system to have Private Keys in separate physycally protected box (safe)


* Forgetting passphrase to your Private Key file

```{r}
# NB: !!!simulating disaster, forgot passphrase!!! 
secret_encrypted <- read_rds("mtcars.Encrypted")

# decrypting the list from R Environment
decrypt_envelope(data = secret_encrypted$data,
                 iv = secret_encrypted$iv,
                 session = secret_encrypted$session,
                 key = "private.key",
                 password = "forgotten") %>% 
  # getting back original object in a form of the data frame
  unserialize() 
```

oops, error...

try to record it somewhere... ???


The last disaster that can happen is about keeping your data leak. Perhaps unintentionally...

For example:

* you can submit your private keys to the version control public repository
* you may use public computer with R installed and you would not delete history or content of Console leaking passphrase or even private key
* you can save your **.Rhistory** file to the version control public repository ...

Simple suggestions can be:

* Use .gitignore to exclude some files from public repositories
* If you think that you submitted some private key to the repository - immediately decrypt your information and replace your private keys
* Use 'pipe' operator to avoid storing extra objects in R Environment
* Clean History, Console and R Environment
* Have a system to periodically decrypt, generate keys, renew keys and encrypt again. Use your encrypted data periodically perhaps every 2 weeks...
* Practice on dummy data first, especially after longer periods of not using your code...
* Write the instructions on paper and share it to your trusted person

```{r}
# remove the content of the R Environment
remove(list = ls())
```

As you may see managing your secrets is really difficult today!!! Just a side note!!!

Now it's time for me to thank you for reaching this far in the course. I would love to see you joining in to the further chapter of the course which will be the case studies where we will be discussing various practical situations of using our new CRYPTOGRAPHY expertise!!!

Before that I will highly recommend you to visit the QUIZ where I put a lot of questions designed to keep yourself alerted on the risks...